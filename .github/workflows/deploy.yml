name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        script: |
          echo "ğŸš€ Starting deployment..."
          
          # è¿›å…¥é¡¹ç›®ç›®å½•
          cd ~/scraper || exit 1
          
          # æ‹‰å–æœ€æ–°ä»£ç 
          echo "ğŸ“¥ Pulling latest code from GitHub..."
          git pull origin main
          
          # æ£€æŸ¥Chromeæ˜¯å¦å·²å®‰è£…
          if ! command -v google-chrome &> /dev/null; then
            echo "ğŸ”§ Chrome not found, installing..."
            chmod +x scripts/deployment/install_chrome.sh
            ./scripts/deployment/install_chrome.sh
          else
            echo "âœ… Chrome already installed: $(google-chrome --version)"
          fi
          
          # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°ä¾èµ–
          if git diff HEAD@{1} HEAD -- requirements.txt | grep -q '^[+-]'; then
            echo "ğŸ“¦ Requirements changed, updating dependencies..."
            pip3 install -r requirements.txt --user --upgrade
          fi
          
          # é‡å¯æœåŠ¡
          echo "ğŸ”„ Restarting services..."
          
          # ä½¿ç”¨æœåŠ¡è„šæœ¬åœæ­¢å’Œå¯åŠ¨
          if [ -f scripts/services/stop_services.sh ]; then
            chmod +x scripts/services/stop_services.sh
            ./scripts/services/stop_services.sh || true
          else
            # å›é€€æ–¹æ¡ˆï¼šæ‰‹åŠ¨åœæ­¢
            pkill -f simple_app.py || true
            pkill -f scheduler_daemon.py || true
            sleep 2
          fi
          
          # æ¸…ç†å¯èƒ½å ç”¨çš„ç«¯å£
          lsof -ti:8080 | xargs kill -9 2>/dev/null || true
          
          # å¯åŠ¨æœåŠ¡ï¼ˆåå°è¿è¡Œï¼Œé¿å…SSHè¶…æ—¶ï¼‰
          if [ -f scripts/services/start_services.sh ]; then
            chmod +x scripts/services/start_services.sh
            nohup ./scripts/services/start_services.sh > /tmp/deploy_start.log 2>&1 &
            sleep 5
            
            # æ£€æŸ¥æœåŠ¡æ˜¯å¦å¯åŠ¨æˆåŠŸ
            if pgrep -f simple_app.py > /dev/null && pgrep -f scheduler_daemon.py > /dev/null; then
              echo "âœ… Services started successfully"
              ps aux | grep python3 | grep -v grep
            else
              echo "âŒ Services failed to start"
              cat /tmp/deploy_start.log
              exit 1
            fi
          else
            # å›é€€æ–¹æ¡ˆï¼šæ‰‹åŠ¨å¯åŠ¨
            cd ~/scraper
            # åŠ è½½ç¯å¢ƒå˜é‡
            if [ -f .env ]; then
              export $(cat .env | grep -v '^#' | grep -v '^$' | xargs)
            fi
            nohup python3 simple_app.py > app.log 2>&1 &
            nohup python3 scheduler_daemon.py > scheduler.log 2>&1 &
            sleep 5
            
            # æ£€æŸ¥è¿›ç¨‹
            if pgrep -f simple_app.py > /dev/null; then
              echo "âœ… Web app is running"
            else
              echo "âŒ Web app failed to start"
              tail -20 app.log
              exit 1
            fi
            
            if pgrep -f scheduler_daemon.py > /dev/null; then
              echo "âœ… Scheduler is running"
            else
              echo "âŒ Scheduler failed to start"
              tail -20 scheduler.log
              exit 1
            fi
          fi
          
          echo "âœ… Deployment completed successfully!"
          echo "ğŸ“Š Current running processes:"
          ps aux | grep python3 | grep -v grep

