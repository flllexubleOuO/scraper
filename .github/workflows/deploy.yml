name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch: # 允许手动触发

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        command_timeout: 10m
        script: |
          echo "🚀 Starting deployment..."
          
          # 进入项目目录
          cd ~/scraper || exit 1
          
          # 拉取最新代码
          echo "📥 Pulling latest code from GitHub..."
          git pull origin main
          
          # 检查Chrome是否已安装
          if ! command -v google-chrome &> /dev/null; then
            echo "🔧 Chrome not found, installing..."
            chmod +x scripts/deployment/install_chrome.sh
            ./scripts/deployment/install_chrome.sh
          else
            echo "✅ Chrome already installed: $(google-chrome --version)"
          fi
          
          # 检查是否需要更新依赖
          if git diff HEAD@{1} HEAD -- requirements.txt | grep -q '^[+-]'; then
            echo "📦 Requirements changed, updating dependencies..."
            pip3 install -r requirements.txt --user --upgrade
          fi
          
          # 重启服务（简化版，避免SSH超时）
          echo "🔄 Restarting services..."
          
          # 强制停止所有相关进程（后台执行避免阻塞）
          (pkill -9 -f simple_app.py; pkill -9 -f scheduler_daemon.py; lsof -ti:8080 | xargs kill -9 2>/dev/null) &
          sleep 3
          
          # 加载环境变量
          if [ -f .env ]; then
            export $(cat .env | grep -v '^#' | grep -v '^$' | xargs) 2>/dev/null || true
          fi
          
          # 启动服务（后台运行）
          cd ~/scraper
          nohup python3 simple_app.py > app.log 2>&1 &
          nohup python3 scheduler_daemon.py > scheduler.log 2>&1 &
          
          # 等待服务启动
          sleep 5
          
          # 检查服务状态
          echo "🔍 Checking service status..."
          if pgrep -f simple_app.py > /dev/null; then
            echo "✅ Web app is running"
          else
            echo "❌ Web app failed to start"
            tail -20 app.log
            exit 1
          fi
          
          if pgrep -f scheduler_daemon.py > /dev/null; then
            echo "✅ Scheduler is running"
          else
            echo "❌ Scheduler failed to start"
            tail -20 scheduler.log
            exit 1
          fi
          
          echo "✅ Deployment completed successfully!"
          echo "📊 Running processes:"
          ps aux | grep -E "(simple_app|scheduler_daemon)" | grep -v grep

