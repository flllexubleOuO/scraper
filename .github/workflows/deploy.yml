name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        command_timeout: 10m
        script: |
          echo "ğŸš€ Starting deployment..."
          
          # è¿›å…¥é¡¹ç›®ç›®å½•
          cd ~/scraper || exit 1
          
          # æ‹‰å–æœ€æ–°ä»£ç 
          echo "ğŸ“¥ Pulling latest code from GitHub..."
          git pull origin main
          
          # æ£€æŸ¥Chromeæ˜¯å¦å·²å®‰è£…
          if ! command -v google-chrome &> /dev/null; then
            echo "ğŸ”§ Chrome not found, installing..."
            chmod +x scripts/deployment/install_chrome.sh
            ./scripts/deployment/install_chrome.sh
          else
            echo "âœ… Chrome already installed: $(google-chrome --version)"
          fi
          
          # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°ä¾èµ–
          if git diff HEAD@{1} HEAD -- requirements.txt | grep -q '^[+-]'; then
            echo "ğŸ“¦ Requirements changed, updating dependencies..."
            pip3 install -r requirements.txt --user --upgrade
          fi
          
          # éƒ¨ç½²æ–°ç‰ˆæœ¬ï¼ˆè®©æ–°è¿›ç¨‹æ›¿æ¢æ—§è¿›ç¨‹ï¼‰
          echo "ğŸ”„ Deploying new version..."
          
          # åˆ›å»ºéƒ¨ç½²è„šæœ¬ï¼ˆåœ¨SSHæ–­å¼€åç»§ç»­è¿è¡Œï¼‰
          cat > ~/scraper/deploy_bg.sh << 'DEPLOY_SCRIPT'
          #!/bin/bash
          # ç­‰å¾…ä¸€ä¸‹ç¡®ä¿SSHå·²æ–­å¼€
          sleep 2
          
          # åœæ­¢æ—§è¿›ç¨‹
          pkill -f simple_app.py 2>/dev/null || true
          pkill -f scheduler_daemon.py 2>/dev/null || true
          sleep 1
          
          # å¼ºåˆ¶æ¸…ç†
          pkill -9 -f simple_app.py 2>/dev/null || true
          pkill -9 -f scheduler_daemon.py 2>/dev/null || true
          fuser -k 8080/tcp 2>/dev/null || true
          sleep 1
          
          # åŠ è½½ç¯å¢ƒå˜é‡
          cd ~/scraper
          if [ -f .env ]; then
            export $(cat .env | grep -v '^#' | grep -v '^$' | xargs) 2>/dev/null || true
          fi
          
          # å¯åŠ¨æ–°è¿›ç¨‹
          nohup python3 simple_app.py > app.log 2>&1 &
          nohup python3 scheduler_daemon.py > scheduler.log 2>&1 &
          
          # è®°å½•éƒ¨ç½²ç»“æœ
          sleep 3
          if pgrep -f simple_app.py > /dev/null && pgrep -f scheduler_daemon.py > /dev/null; then
            echo "$(date): Deployment successful" >> ~/scraper/deploy.log
          else
            echo "$(date): Deployment failed" >> ~/scraper/deploy.log
          fi
          DEPLOY_SCRIPT
          
          # è®¾ç½®æ‰§è¡Œæƒé™å¹¶åœ¨åå°è¿è¡Œ
          chmod +x ~/scraper/deploy_bg.sh
          nohup ~/scraper/deploy_bg.sh > /dev/null 2>&1 &
          
          echo "âœ… Deployment script started in background"
          echo "ğŸ“ Background deployment will complete in ~10 seconds"
          echo "ğŸ“Š Check deployment status:"
          echo "   tail -f ~/scraper/deploy.log"
          echo "   ps aux | grep python3"
          
          echo ""
          echo "ğŸ‰ GitHub Actions deployment completed!"
          echo "â³ Services are restarting in background..."

